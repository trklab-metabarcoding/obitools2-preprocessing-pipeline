---
title: "Step 2a - data preparation"
author: "T. Divoll"
date: "2023-09-12"
output: 
  html_document:
  df_print: paged
  toc: true
---

```{r setup, include=FALSE}
# set global chunk parameters here
knitr::opts_chunk$set(echo = TRUE)
here::i_am("documents/Step2a_data_prep.Rmd")
```

## Environment Setup

This notebook can be used to run the OBITools 3 pipeline and serve as a tutorial. Run through each code chunk and inspect the outputs or select Run All from the dropdown above to run the whole pipeline. First, update the parameters in the first code chunk.

```{r include=FALSE}
install.packages("pacman")
pacman::p_load(here, tidyverse, readxl, Biostrings, stringr)
```

#### Update parameters and thresholds
```{r}
cutadapt_mismatch <- 2 # -e in cutadapt
min_read_count <- 1000
min_read_length <- # -l in obigrep
max_read_length <- # -L in obigrep
clean_threshold <- 0.05 # -r in obiclean
F_primer <- DNAString("GGGCAATCCTGAGCCAA")
R_primer <- DNAString("CCATTGAGTCTCTGCACCTATC")
```

#### Set up standard path variables
```{r}
samples_dir <- here("data")
output_dir <- here("results")
batch_file_list <- list.files(samples_dir, full.names=T, pattern="xlsx")
sample_sheet <- read_xlsx(here("data/sample_sheet_test.xlsx"), col_types = "guess")
sample_sheet_metadata <- read_xlsx(here("data/sample_sheet_test_metadata.xlsx"), col_types = "guess")
Sys.setenv(samples_dir=samples_dir)
```

#### Generate some additional parameters from inputs
```{r}
reverseComplement(F_primer)
reverseComplement(R_primer)
```
The following dates are pulled from the sample sheet and can be used to filter out dates in case of contamination. The unique extraction, PCR, and sequencing dates are cast to lists that we can then index into later.
```{r}
extraction_date <- as.list(unique(sample_sheet$`Ext date`))
pcr_date <- as.list(unique(sample_sheet$`PCR date`))
sequencing_date <- as.list(unique(sample_sheet$`seq date`))
```

#### Rename files with project-specific sample names
```{r}
file_names <- list.files(samples_dir, pattern=".gz", full.names = T) 
```

```{r}
lab_name <- sample_sheet$SampleName
field_name <- sample_sheet$SampleID
df <- data.frame(field_name, lab_name)
file_names <- stringr::str_replace_all(file_names, setNames(df$field_name, df$lab_name))
```

```{r}
file_names_original
```

